---
title: "FinalProjectSetup"
output: word_document
date: "2024-12-03"
---
  
  

```{r}
# Install and load required packages
if (!require("BiocManager")) install.packages("BiocManager")

if (!require("TCGAbiolinks")) BiocManager::install("TCGAbiolinks")
library(TCGAbiolinks)

if (!require("survival")) install.packages("survival")
library(survival)

if (!require("survminer")) install.packages("survminer")
library(survminer)

if (!require("ggplot2")) install.packages("ggplot2")
library(ggplot2)

if (!require("maftools")) BiocManager::install("maftools")
library(maftools)

if (!require("SummarizedExperiment")) BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)

if (!require("DESeq2")) BiocManager::install("DESeq2")
library(DESeq2)

if (!require("sesame")) BiocManager::install("sesame")
library(sesame)

if (!require("sesameData")) BiocManager::install("sesameData")
library(sesameData)

if (!require("limma")) BiocManager::install("limma")
library(limma)
```


```{r}
#transcriptomic
rna_query <- GDCquery(
  project = "TCGA-OV",
  data.category = "Transcriptome Profiling",
  data.type = "Gene Expression Quantification",
  workflow.type = "STAR - Counts"
)
GDCdownload(rna_query)
rna_se <- GDCprepare(rna_query)
ov_rna_clinical <- as.data.frame(rna_se@colData)
```


```{r}
# clinical
clin_query <- GDCquery(
  project = "TCGA-OV",
  data.category = "Clinical",
  data.type = "Clinical Supplement",
  data.format = "BCR Biotab"
)
GDCdownload(clin_query)
clinical.BCRtab.all <- GDCprepare(clin_query)
ov_clinical <- clinical.BCRtab.all$clinical_patient_ov[-c(1,2),]
colnames(ov_clinical)[colnames(ov_clinical) == "bcr_patient_barcode"] <- "Tumor_Sample_Barcode"
```


```{r}
#mutation data prep
maf_query <- GDCquery(
  project = "TCGA-OV",
  data.category = "Simple Nucleotide Variation",
  access = "open",
  data.type = "Masked Somatic Mutation",
  workflow.type = "Aliquot Ensemble Somatic Variant Merging and Masking"
)
GDCdownload(maf_query)
maf <- GDCprepare(maf_query)
maf_object <- read.maf(maf = maf, clinicalData = ov_clinical, isTCGA = TRUE)

#add BRCA mutation status to clinical data
brca1_mask <- maf_object@data$Hugo_Symbol == "BRCA1"
brca2_mask <- maf_object@data$Hugo_Symbol == "BRCA2"

brca1_barcodes <- unique(maf_object@data$Tumor_Sample_Barcode[brca1_mask])
brca2_barcodes <- unique(maf_object@data$Tumor_Sample_Barcode[brca2_mask])

ov_clinical$BRCA1 <- ifelse(ov_clinical$Tumor_Sample_Barcode %in% brca1_barcodes, "Mutated", "Not Mutated")
ov_clinical$BRCA2 <- ifelse(ov_clinical$Tumor_Sample_Barcode %in% brca2_barcodes, "Mutated", "Not Mutated")
ov_clinical$BRCA <- ifelse(ov_clinical$BRCA1 == "Mutated" | ov_clinical$BRCA2 == "Mutated", "Mutated", "Not Mutated")

ov_clinical$BRCA <- factor(ov_clinical$BRCA, levels = c("Not Mutated", "Mutated"))
ov_clinical$BRCA1 <- factor(ov_clinical$BRCA1, levels = c("Not Mutated", "Mutated"))
ov_clinical$BRCA2 <- factor(ov_clinical$BRCA2, levels = c("Not Mutated", "Mutated"))
```


```{r}
#survival data prep
# Convert survival columns to numeric
ov_clinical$death_days_to <- suppressWarnings(as.numeric(ov_clinical$death_days_to))
ov_clinical$last_contact_days_to <- suppressWarnings(as.numeric(ov_clinical$last_contact_days_to))

# Combine `death_days_to` and `last_contact_days_to` into `survival_time`
ov_clinical$survival_time <- ifelse(
  !is.na(ov_clinical$death_days_to),
  ov_clinical$death_days_to,
  ov_clinical$last_contact_days_to
)

# Remove rows with missing `survival_time`
ov_clinical <- ov_clinical[!is.na(ov_clinical$survival_time), ]

# Create `death_event` column based on `vital_status`
ov_clinical$death_event <- ifelse(ov_clinical$vital_status == "Dead", TRUE, FALSE)
```


KM plots
```{r}
# Kaplan-Meier survival curves
survival_object <- Surv(time = ov_clinical$survival_time, event = ov_clinical$death_event)

fit_brca <- survfit(survival_object ~ BRCA, data = ov_clinical)
fit_brca1 <- survfit(survival_object ~ BRCA1, data = ov_clinical)
fit_brca2 <- survfit(survival_object ~ BRCA2, data = ov_clinical)

```

```{r}
# Generate KM plots
plot_brca <- ggsurvplot(
  fit_brca,
  pval = TRUE,
  risk.table = TRUE,
  title = "Kaplan-Meier Curve: BRCA Mutation Status",
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.labs = c("Not Mutated", "Mutated")
)

plot_brca1 <- ggsurvplot(
  fit_brca1,
  pval = TRUE,
  risk.table = TRUE,
  title = "Kaplan-Meier Curve: BRCA1 Mutation Status",
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.labs = c("Not Mutated", "Mutated")
)

plot_brca2 <- ggsurvplot(
  fit_brca2,
  pval = TRUE,
  risk.table = TRUE,
  title = "Kaplan-Meier Curve: BRCA2 Mutation Status",
  xlab = "Time (days)",
  ylab = "Survival Probability",
  legend.labs = c("Not Mutated", "Mutated")
)

# Save KM plots
ggsave("KM_BRCAMutations.png", plot = plot_brca$plot, width = 8, height = 6)
ggsave("KM_BRCA1.png", plot = plot_brca1$plot, width = 8, height = 6)
ggsave("KM_BRCA2.png", plot = plot_brca2$plot, width = 8, height = 6)

# Display plots
print(plot_brca$plot)
print(plot_brca1$plot)
print(plot_brca2$plot)
```



